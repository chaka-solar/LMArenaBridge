# PostgreSQL æ•°æ®åº“è¡¨æ‰«æå·¥å…·

è¿™æ˜¯ä¸€å¥—ç”¨äºŽåœ¨ PostgreSQL æ•°æ®åº“ä¸­æ‰¹é‡æ‰«æè¡¨æ•°æ®çš„å·¥å…·é›†ï¼Œä¸“é—¨ç”¨äºŽæŸ¥æ‰¾åŒ…å«ç‰¹å®šå€¼ï¼ˆ'è¨‚å–®' å’Œ 'å‡ºè²¨å–®'ï¼‰çš„è®°å½•ã€‚

## ðŸ“‹ åŠŸèƒ½ç‰¹æ€§

- âœ… **æ‰¹é‡æ‰«æ**ï¼šå°†æ‰€æœ‰è¡¨åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹ 100 ä¸ªè¡¨ï¼ˆå¯é…ç½®ï¼‰
- âœ… **æ™ºèƒ½è¿‡æ»¤**ï¼šè‡ªåŠ¨æŽ’é™¤ç³»ç»Ÿè¡¨ï¼ˆpg_* å’Œ information_schema.*ï¼‰
- âœ… **å…¨å­—æ®µæœç´¢**ï¼šæ‰«ææ‰€æœ‰å¯è½¬æ¢ä¸ºæ–‡æœ¬çš„åˆ—ç±»åž‹
- âœ… **ç‹¬ç«‹æ‰§è¡Œ**ï¼šæ¯ä¸ªæ‰¹æ¬¡è„šæœ¬å¯ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“
- âœ… **è¯¦ç»†è¾“å‡º**ï¼šæ˜¾ç¤ºè¡¨åã€åˆ—åã€åŒ¹é…è¡Œæ•°å’Œç¤ºä¾‹æ•°æ®
- âœ… **é”™è¯¯å¤„ç†**ï¼šè‡ªåŠ¨è·³è¿‡æ— æ³•å¤„ç†çš„åˆ—ç±»åž‹
- âœ… **è¿›åº¦è·Ÿè¸ª**ï¼šå®žæ—¶æ˜¾ç¤ºæ‰«æè¿›åº¦å’Œç»“æžœ
- âœ… **ç»“æžœæ±‡æ€»**ï¼šç”Ÿæˆç»Ÿä¸€çš„æ±‡æ€»æŠ¥å‘Š

## ðŸ“ æ–‡ä»¶è¯´æ˜Ž

```
postgres_scan_scripts/
â”œâ”€â”€ README.md                           # æœ¬æ–‡æ¡£
â”œâ”€â”€ generate_scan_batches.py            # Python è„šæœ¬ç”Ÿæˆå™¨ï¼ˆæŽ¨èï¼‰
â”œâ”€â”€ generate_batch_scripts.sql          # SQL è„šæœ¬ç”Ÿæˆå™¨ï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰
â”œâ”€â”€ batch_template.sql                  # æ‰¹æ¬¡è„šæœ¬æ¨¡æ¿
â”œâ”€â”€ example_batch_001_001_100.sql       # ç¤ºä¾‹æ‰¹æ¬¡è„šæœ¬
â””â”€â”€ run_all_batches.sh                  # æ‰¹é‡æ‰§è¡Œè„šæœ¬ï¼ˆShellï¼‰
```

## ðŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³• 1ï¼šä½¿ç”¨ Python è„šæœ¬ç”Ÿæˆå™¨ï¼ˆæŽ¨èï¼‰

#### å‰ææ¡ä»¶
```bash
# å®‰è£… Python ä¾èµ–
pip install psycopg2-binary
```

#### æ­¥éª¤ 1ï¼šç”Ÿæˆæ‰¹æ¬¡è„šæœ¬
```bash
cd postgres_scan_scripts

# åŸºæœ¬ç”¨æ³•
python generate_scan_batches.py \
    --host localhost \
    --port 5432 \
    --database your_database \
    --user postgres \
    --output-dir ./batches

# ç³»ç»Ÿä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œæˆ–ä½¿ç”¨ --password å‚æ•°
```

#### æ­¥éª¤ 2ï¼šæ‰§è¡Œæ‰¹æ¬¡è„šæœ¬

**æ–¹å¼ Aï¼šé€ä¸ªæ‰§è¡Œ**
```bash
cd batches
psql -U postgres -d your_database -f batch_001_0001_0100.sql > output_001.txt
psql -U postgres -d your_database -f batch_002_0101_0200.sql > output_002.txt
# ...
```

**æ–¹å¼ Bï¼šæ‰¹é‡æ‰§è¡Œï¼ˆä½¿ç”¨æä¾›çš„ Shell è„šæœ¬ï¼‰**
```bash
# è¿”å›žä¸Šçº§ç›®å½•
cd ..

# æ‰§è¡Œæ‰€æœ‰æ‰¹æ¬¡
./run_all_batches.sh -h localhost -d your_database -u postgres -o ./results

# æˆ–ä½¿ç”¨çŽ¯å¢ƒå˜é‡
export DB_HOST=localhost
export DB_NAME=your_database
export DB_USER=postgres
export PGPASSWORD=your_password
./run_all_batches.sh
```

**æ–¹å¼ Cï¼šä½¿ç”¨å¾ªçŽ¯æ‰¹é‡æ‰§è¡Œ**
```bash
cd batches
for f in batch_*.sql; do
    echo "æ‰§è¡Œ $f ..."
    psql -U postgres -d your_database -f "$f" > "output_${f%.sql}.txt"
done
```

### æ–¹æ³• 2ï¼šä½¿ç”¨ SQL è„šæœ¬ç”Ÿæˆå™¨

å¦‚æžœæ— æ³•ä½¿ç”¨ Pythonï¼Œå¯ä»¥ä½¿ç”¨çº¯ SQL æ–¹å¼ï¼š

```bash
# è¿žæŽ¥æ•°æ®åº“å¹¶æ‰§è¡Œç”Ÿæˆå™¨è„šæœ¬
psql -U postgres -d your_database -f generate_batch_scripts.sql

# è¿™ä¼šæ˜¾ç¤ºè¡¨åˆ—è¡¨å’Œæ‰¹æ¬¡ä¿¡æ¯ï¼Œç„¶åŽéœ€è¦æ‰‹åŠ¨åˆ›å»ºæ‰¹æ¬¡è„šæœ¬
# æˆ–è€…ä½¿ç”¨å¯¼å‡ºçš„ tables_list.csv é…åˆå…¶ä»–å·¥å…·ç”Ÿæˆ
```

## ðŸ“Š è¾“å‡ºæ ¼å¼

### æ‰¹æ¬¡æ‰§è¡Œè¾“å‡º

æ¯ä¸ªæ‰¹æ¬¡æ‰§è¡ŒåŽä¼šæ˜¾ç¤ºï¼š

```
==========================================
æ‰¹æ¬¡ 001 æ‰«æå®Œæˆ
==========================================

 æ‰¹æ¬¡ | è¡¨å              | åˆ—å        | æœç´¢å€¼  | åŒ¹é…è¡Œæ•° | ç¤ºä¾‹æ•°æ®
------+-------------------+-------------+---------+----------+------------------
    1 | public.orders     | order_type  | è¨‚å–®    |      156 | è¨‚å–®-20240108-001
    1 | public.orders     | description | è¨‚å–®    |       89 | å®¢æˆ·è®¢å•å¤„ç†ä¸­
    1 | public.shipments  | type        | å‡ºè²¨å–®  |      234 | å‡ºè²¨å–®-2024-001
```

### æ±‡æ€»ç»Ÿè®¡

```
 æ‰«æè¡¨æ•° | æ‰¾åˆ°åŒ¹é…çš„åˆ—æ•° | æ€»åŒ¹é…è¡Œæ•°
----------+----------------+------------
      100 |              3 |        479
```

## âš™ï¸ é…ç½®é€‰é¡¹

### Python è„šæœ¬å‚æ•°

```bash
python generate_scan_batches.py [é€‰é¡¹]

é€‰é¡¹:
  --host HOST           æ•°æ®åº“ä¸»æœº (é»˜è®¤: localhost)
  --port PORT           æ•°æ®åº“ç«¯å£ (é»˜è®¤: 5432)
  --database DB         æ•°æ®åº“åç§° (å¿…éœ€)
  --user USER           æ•°æ®åº“ç”¨æˆ·å (å¿…éœ€)
  --password PASSWORD   æ•°æ®åº“å¯†ç  (å¯é€‰ï¼Œä¸æä¾›ä¼šæç¤ºè¾“å…¥)
  --output-dir DIR      è¾“å‡ºç›®å½• (é»˜è®¤: ./batches)
  --batch-size SIZE     æ¯æ‰¹è¡¨æ•°é‡ (é»˜è®¤: 100)
```

### Shell è„šæœ¬å‚æ•°

```bash
./run_all_batches.sh [é€‰é¡¹]

é€‰é¡¹:
  -h, --host HOST       æ•°æ®åº“ä¸»æœº
  -p, --port PORT       æ•°æ®åº“ç«¯å£
  -d, --database DB     æ•°æ®åº“åç§° (å¿…éœ€)
  -u, --user USER       æ•°æ®åº“ç”¨æˆ·
  -o, --output DIR      è¾“å‡ºç›®å½•
  --start NUM           èµ·å§‹æ‰¹æ¬¡ç¼–å·
  --end NUM             ç»“æŸæ‰¹æ¬¡ç¼–å·
```

## ðŸ“ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ‰«æç”Ÿäº§æ•°æ®åº“

```bash
# ç”Ÿæˆè„šæœ¬
python generate_scan_batches.py \
    --host prod-db.example.com \
    --port 5432 \
    --database production_db \
    --user readonly_user \
    --output-dir ./prod_scan_batches

# åˆ†æ‰¹æ¬¡æ‰§è¡Œï¼ˆé¿å…é•¿æ—¶é—´é”å®šï¼‰
cd prod_scan_batches
psql -h prod-db.example.com -U readonly_user -d production_db \
    -f batch_001_0001_0100.sql > output_001.txt
```

### åœºæ™¯ 2ï¼šå¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ‰¹æ¬¡

```bash
# ä½¿ç”¨ GNU Parallel å¹¶è¡Œæ‰§è¡Œ
cd batches
ls batch_*.sql | parallel -j 4 \
    "psql -U postgres -d mydb -f {} > output_{/.}.txt"
```

### åœºæ™¯ 3ï¼šä»…æ‰«æç‰¹å®šæ‰¹æ¬¡èŒƒå›´

```bash
# ä»…æ‰§è¡Œæ‰¹æ¬¡ 5-10
./run_all_batches.sh \
    -d your_database \
    -u postgres \
    --start 5 \
    --end 10
```

## ðŸ” ç»“æžœåˆ†æž

### æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…ç»“æžœ

```bash
# æŸ¥çœ‹æ‰€æœ‰åŒ…å«åŒ¹é…çš„æ‰¹æ¬¡
grep -l "æ‰¾åˆ°åŒ¹é…" results/*_output.txt

# æå–æ‰€æœ‰åŒ¹é…çš„è¡¨å’Œåˆ—
grep "æ‰¾åˆ°åŒ¹é…" results/*_output.txt | \
    sed -E 's/.*æ‰¾åˆ°åŒ¹é…: ([^ ]+) \(åˆ—: ([^)]+)\).*/\1 - \2/' | \
    sort -u

# ç»Ÿè®¡æ€»åŒ¹é…è¡Œæ•°
grep "æ€»åŒ¹é…è¡Œæ•°" results/*_output.txt | \
    awk '{sum += $NF} END {print "æ€»è®¡:", sum}'
```

### ç”Ÿæˆ CSV æŠ¥å‘Š

```bash
# ä»Žè¾“å‡ºæ–‡ä»¶æå–ç»“æžœä¸º CSV
cat results/*_output.txt | \
    grep -A 1000 "æ‰¹æ¬¡.*è¡¨å.*åˆ—å" | \
    grep -E "^\s+[0-9]+" | \
    sed 's/|/,/g' > scan_results.csv
```

## ðŸ› ï¸ é«˜çº§é…ç½®

### è‡ªå®šä¹‰æœç´¢å€¼

å¦‚æžœéœ€è¦æœç´¢å…¶ä»–å€¼ï¼Œä¿®æ”¹ `generate_scan_batches.py` ä¸­çš„ `search_values` åˆ—è¡¨ï¼š

```python
# ç¬¬ 57 è¡Œé™„è¿‘
search_values = ["è¨‚å–®", "å‡ºè²¨å–®"]

# ä¿®æ”¹ä¸ºï¼š
search_values = ["è¨‚å–®", "å‡ºè²¨å–®", "ç™¼ç¥¨", "é€€è²¨å–®"]
```

### è°ƒæ•´æ‰¹æ¬¡å¤§å°

```bash
# æ¯æ‰¹ 50 ä¸ªè¡¨
python generate_scan_batches.py \
    --database mydb \
    --user postgres \
    --batch-size 50
```

### æœç´¢ç‰¹å®šæ¨¡å¼

å¦‚æžœéœ€è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ–å…¶ä»–æ¨¡å¼ï¼Œä¿®æ”¹ç”Ÿæˆçš„ SQL ä¸­çš„ LIKE è¯­å¥ï¼š

```sql
-- ä»Žï¼š
WHERE %I::text LIKE '%%%s%%'

-- æ”¹ä¸ºï¼ˆä½¿ç”¨æ­£åˆ™ï¼‰ï¼š
WHERE %I::text ~ '%s'

-- æˆ–ä½¿ç”¨ä¸åŒºåˆ†å¤§å°å†™ï¼š
WHERE %I::text ILIKE '%%%s%%'
```

## ðŸ” å®‰å…¨å»ºè®®

1. **ä½¿ç”¨åªè¯»è´¦æˆ·**ï¼šå»ºè®®ä½¿ç”¨åªè¯»æ•°æ®åº“ç”¨æˆ·æ‰§è¡Œæ‰«æ
2. **è®¾ç½®å¯†ç **ï¼šä½¿ç”¨ `.pgpass` æ–‡ä»¶æˆ– `PGPASSWORD` çŽ¯å¢ƒå˜é‡
3. **é™åˆ¶è¿žæŽ¥**ï¼šåœ¨éžé«˜å³°æœŸæ‰§è¡Œå¤§è§„æ¨¡æ‰«æ
4. **å¤‡ä»½æ•°æ®**ï¼šæ‰§è¡Œå‰ç¡®ä¿æœ‰å®Œæ•´å¤‡ä»½
5. **æµ‹è¯•çŽ¯å¢ƒ**ï¼šå…ˆåœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯è„šæœ¬

### è®¾ç½® .pgpass æ–‡ä»¶

```bash
# åˆ›å»º .pgpass æ–‡ä»¶
cat > ~/.pgpass << EOF
localhost:5432:mydb:postgres:password123
prod-db:5432:prod_db:readonly:secret456
EOF

# è®¾ç½®æƒé™
chmod 600 ~/.pgpass

# çŽ°åœ¨å¯ä»¥æ— å¯†ç æ‰§è¡Œ
psql -U postgres -d mydb -f batch_001.sql
```

## ðŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å‡å°‘æ•°æ®åº“è´Ÿè½½

```sql
-- åœ¨æ‰¹æ¬¡è„šæœ¬ä¸­æ·»åŠ å»¶è¿Ÿï¼ˆæ¯ä¸ªè¡¨ä¹‹é—´æš‚åœ 1 ç§’ï¼‰
DO $$ BEGIN PERFORM pg_sleep(1); END $$;
```

### å¹¶è¡Œæ‰§è¡Œ

```bash
# ä½¿ç”¨ PostgreSQL å¹¶è¡ŒæŸ¥è¯¢ï¼ˆéœ€è¦é…ç½® max_parallel_workersï¼‰
SET max_parallel_workers_per_gather = 4;
```

### é™åˆ¶æ‰«ææ—¶é—´

```bash
# è®¾ç½®æŸ¥è¯¢è¶…æ—¶ï¼ˆ30 åˆ†é’Ÿï¼‰
psql -v ON_ERROR_STOP=1 \
    -c "SET statement_timeout = '30min';" \
    -f batch_001.sql
```

## ðŸ› æ•…éšœæŽ’æŸ¥

### é—®é¢˜ 1ï¼šè¿žæŽ¥å¤±è´¥

```
é”™è¯¯: FATAL:  password authentication failed
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç 
- ä½¿ç”¨ `PGPASSWORD` çŽ¯å¢ƒå˜é‡æˆ– `.pgpass` æ–‡ä»¶
- éªŒè¯ `pg_hba.conf` é…ç½®

### é—®é¢˜ 2ï¼šæƒé™ä¸è¶³

```
é”™è¯¯: ERROR:  permission denied for table xxx
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- æŽˆäºˆç”¨æˆ·æ‰€æœ‰è¡¨çš„æŸ¥è¯¢æƒé™
GRANT SELECT ON ALL TABLES IN SCHEMA public TO your_user;
```

### é—®é¢˜ 3ï¼šè„šæœ¬æ‰§è¡Œç¼“æ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å‡å°æ‰¹æ¬¡å¤§å°ï¼ˆä½¿ç”¨ `--batch-size 50`ï¼‰
- åœ¨éžé«˜å³°æœŸæ‰§è¡Œ
- è€ƒè™‘å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ‰¹æ¬¡
- æ·»åŠ è¡¨æˆ–åˆ—çš„è¿‡æ»¤æ¡ä»¶

### é—®é¢˜ 4ï¼šæ‰¾ä¸åˆ°ç”Ÿæˆçš„è„šæœ¬

**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹ Python è„šæœ¬è¾“å‡ºçš„ç›®å½•
ls -la ./batches/

# éªŒè¯è„šæœ¬æ˜¯å¦æ­£ç¡®ç”Ÿæˆ
head -20 ./batches/batch_001_*.sql
```

## ðŸ“š æŠ€æœ¯è¯´æ˜Ž

### å…¼å®¹æ€§

- PostgreSQL 9.6+
- Python 3.6+ (ä½¿ç”¨ Python è„šæœ¬æ—¶)
- Bash 4.0+ (ä½¿ç”¨ Shell è„šæœ¬æ—¶)

### åˆ—ç±»åž‹å¤„ç†

è„šæœ¬ä¼šå°è¯•å°†æ‰€æœ‰åˆ—è½¬æ¢ä¸ºæ–‡æœ¬è¿›è¡Œæœç´¢ï¼š
- âœ… æ”¯æŒï¼štext, varchar, char, json, jsonb, xml, æ•°å­—ç±»åž‹, æ—¥æœŸç±»åž‹ç­‰
- âŒ è·³è¿‡ï¼šbinary, bytea ä»¥åŠæ— æ³•è½¬æ¢çš„è‡ªå®šä¹‰ç±»åž‹

### æ€§èƒ½è€ƒè™‘

- æ¯ä¸ªè¡¨çš„æ¯ä¸ªåˆ—ä¼šæ‰§è¡Œä¸€æ¬¡å…¨è¡¨æ‰«æ
- å¤§è¡¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
- å»ºè®®åœ¨æ•°æ®åº“è´Ÿè½½è¾ƒä½Žæ—¶æ‰§è¡Œ
- è€ƒè™‘ä½¿ç”¨è¡¨é‡‡æ ·å‡å°‘æ‰«æé‡

## ðŸ¤ è´¡çŒ®

æ¬¢è¿Žæäº¤é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼

## ðŸ“„ è®¸å¯è¯

æœ¬å·¥å…·é›†å¯è‡ªç”±ä½¿ç”¨å’Œä¿®æ”¹ã€‚

## ðŸ“ž æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. æœ¬ README çš„æ•…éšœæŽ’æŸ¥éƒ¨åˆ†
2. PostgreSQL å®˜æ–¹æ–‡æ¡£
3. æŸ¥çœ‹ç”Ÿæˆçš„è„šæœ¬è¾“å‡ºæ—¥å¿—

---

**æœ€åŽæ›´æ–°**: 2024-01-08
**ç‰ˆæœ¬**: 1.0.0
